package com.tartarugacometa.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import com.conexaofactory.ConnectionFactory;
import com.tartarugacometa.model.Cliente;
import com.tartarugacometa.model.Endereco;

public class EnderecoDAO {

    private ConnectionFactory connection = new ConnectionFactory();
    //lembrar de tratar as exception pra dar um erro de cada metodo e não um erro de runtime que e outro erro aleatorio sem base no codigo 
    public void cadastrarEnderecoDAO(Endereco endereco) {
        String sql = "INSERT INTO enderecos (rua, numero, bairro, cidade, estado, cep, clientes_id) VALUES (?, ?, ?, ?, ?, ?, ?);";

        try (Connection conn = connection.recuperarConexao();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setString(1, endereco.getRua());
            ps.setString(2, endereco.getNumero());
            ps.setString(3, endereco.getBairro());
            ps.setString(4, endereco.getCidade());
            ps.setString(5, endereco.getEstado());
            ps.setString(6, endereco.getCep());
            //obtendo obj de cliente no endere�o para passar id para cliente_id
            ps.setInt(7, endereco.getCliente().getId());

            ps.execute();
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public void atualizarEnderecoDAO(Endereco endereco) {
        String sql = "UPDATE enderecos SET rua=?, numero=?, bairro=?, cidade=?, estado=?, cep=? WHERE id_endereco=?;";

        try (Connection conn = connection.recuperarConexao();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setString(1, endereco.getRua());
            ps.setString(2, endereco.getNumero());
            ps.setString(3, endereco.getBairro());
            ps.setString(4, endereco.getCidade());
            ps.setString(5, endereco.getEstado());
            ps.setString(6, endereco.getCep());
            ps.setInt(7, endereco.getId());

            ps.execute();
            
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public void deletarEnderecoDAO(int id) {
        String sql = "DELETE FROM enderecos WHERE id_endereco = ?;";

        try (Connection conn = connection.recuperarConexao();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, id);
            
            ps.execute();

        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }
    
    public List<Endereco> listarEnderecosDAO() {
        List<Endereco> enderecos = new ArrayList<>();

        String sql = "SELECT enderecos.id_endereco, enderecos.rua, enderecos.numero, " +
        	    "enderecos.bairro, enderecos.cidade, enderecos.estado, enderecos.cep, " +
        	    "clientes.id_cliente, clientes.nome " + 
        	    "FROM enderecos " +                        
        	    "JOIN clientes ON enderecos.clientes_id = clientes.id_cliente;";
       

        try (Connection conn = connection.recuperarConexao();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ResultSet rs = ps.executeQuery();

            while (rs.next()) {
            	
                Cliente cliente = new Cliente();
                cliente.setId(rs.getInt("id_cliente"));
                cliente.setNome(rs.getString("nome"));
            	
                Endereco endereco = new Endereco(
                    rs.getString("rua"),
                    rs.getString("numero"),
                    rs.getString("bairro"),
                    rs.getString("cidade"),
                    rs.getString("estado"),
                    rs.getString("cep")
                );
                endereco.setId(rs.getInt("id_endereco"));
                endereco.setCliente(cliente);
                
                enderecos.add(endereco);
                
            }

            return enderecos;

        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }


}